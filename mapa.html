<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Pontos de Ônibus - BusWay</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }

    /* O mapa deve ocupar toda a altura da tela */
    #map {
      height: 100vh;
    }

    /* Estilo para os botões flutuantes sobre o mapa */
    .floating-buttons {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000; /* Garantir que os botões fiquem acima do mapa */
    }

    .floating-buttons button, .floating-buttons a {
      transition: transform 0.2s ease;
      width: 180px; /* Largura fixa para os botões */
    }

    .floating-buttons button:hover, .floating-buttons a:hover {
      transform: scale(1.05);
    }

    /* Ajustes para dispositivos móveis */
    @media (max-width: 768px) {
      .floating-buttons {
        top: 50%;
        right: 10px;
        left: 10px;
        bottom: 10px;
        flex-direction: row;
        justify-content: space-between;
        gap: 10px;
        padding: 5px;
      }

      /* Ajustando a largura dos botões para caber no dispositivo */
      .floating-buttons button, .floating-buttons a {
        width: 45%; /* Botões vão ocupar 45% da largura em dispositivos móveis */
      }
    }

    /* Estilos de chat */
    #chat {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 320px;
      height: 400px;
      background-color: #1e1e1e;
      border-radius: 10px;
      border: 1px solid #444;
      padding: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      z-index: 999;
    }

    #messages {
      flex-grow: 1;
      overflow-y: auto;
      margin-bottom: 10px;
    }

    .message {
      margin: 8px 0;
      padding: 8px;
      border-radius: 8px;
    }

    .user-msg {
      background-color: #0d6efd;
      color: white;
      align-self: flex-end;
    }

    .ia-msg {
      background-color: #343a40;
      color: white;
      align-self: flex-start;
    }

    #userInput {
      border-radius: 5px;
      padding: 8px;
      border: none;
      background: #2c2c2c;
      color: white;
    }

    /* Estilo para o campo de busca */
    #searchBar {
      position: absolute;
      top: 20px;
      left: 10px;
      z-index: 1000;
      width: 250px;
    }

    /* Estilos para o botão de tema na parte inferior */
    #theme-toggle {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
    }
  </style>
</head>
<body>

  <!-- Campo de busca -->
  <div id="searchBar">
    <input id="addressInput" class="form-control" type="text" placeholder="Buscar endereço...">
    <button class="btn btn-outline-light mt-2 w-100" onclick="buscarEndereco()">
      <i class="bi bi-search"></i> Buscar
    </button>
  </div>

  <!-- Mapa -->
  <div id="map"></div>

  <!-- Botões flutuantes -->
  <div class="floating-buttons">
    <button class="btn btn-primary" onclick="getUserLocation()"><i class="bi bi-geo-alt-fill"></i> Minha localização</button>
    <button class="btn btn-success" onclick="loadBusStops()"><i class="bi bi-arrow-clockwise"></i> Recarregar</button>
    <a class="btn btn-warning" href="horario.html"><i class="bi bi-clock-history"></i> Horários</a>
    <a class="btn btn-info" href="admin.html"><i class="bi bi-lock-fill"></i> Painel Admin</a>
  </div>

  <!-- Botão de alternância de tema na parte inferior -->
  <button class="btn btn-light theme-toggle" id="theme-toggle">
    <i class="bi bi-moon-fill"></i> Modo Escuro
  </button>

  <!-- Chat -->
  <div id="chat">
    <div id="messages"></div>
    <input type="text" id="userInput" class="form-control" placeholder="Digite sua pergunta...">
    <button class="btn btn-light mt-2" onclick="enviarMensagem()"><i class="bi bi-send-fill"></i> Enviar</button>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA-UgQXLtsg1tj0MBpLndSuJiS2hqXRc6c",
      authDomain: "busway-4df70.firebaseapp.com",
      databaseURL: "https://busway-4df70-default-rtdb.firebaseio.com",
      projectId: "busway-4df70",
      storageBucket: "busway-4df70.appspot.com",
      messagingSenderId: "688309345550",
      appId: "1:688309345550:web:761e34139b05a1f8578b5f"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database(app);

    // Criando o mapa
    const map = L.map('map').setView([-23.5505, -46.6333], 13);
    
    // Carregando o tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Função para pegar localização do usuário
    function getUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          map.setView([lat, lon], 15); // Ajustando o mapa para a localização do usuário
          L.marker([lat, lon]).addTo(map).bindPopup('Você está aqui!').openPopup(); // Marcando a posição do usuário
        }, () => alert("Erro ao obter localização."));
      } else {
        alert("Geolocalização não suportada.");
      }
    }

    // Carregando os pontos de ônibus do Firebase
    function loadBusStops() {
      database.ref('pontos').once('value', snapshot => {
        const pontos = snapshot.val();
        if (pontos) {
          for (let id in pontos) {
            const p = pontos[id];
            // Adicionando marcadores no mapa para cada ponto de ônibus
            L.marker([p.latitude, p.longitude])
              .addTo(map)
              .bindPopup(`<strong>${p.nome}</strong><br>${p.tipo}<br>${p.descricao || 'Sem descrição'}`);
          }
        }
      });
    }

    loadBusStops(); // Carregar pontos de ônibus no mapa
    getUserLocation(); // Obter localização do usuário

    // Função para buscar endereço usando Nominatim API
    function buscarEndereco() {
      const endereco = document.getElementById('addressInput').value;
      if (!endereco) return;

      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endereco)}`)
        .then(res => res.json())
        .then(data => {
          if (data.length > 0) {
            const { lat, lon } = data[0];
            map.setView([parseFloat(lat), parseFloat(lon)], 16);
            L.marker([lat, lon]).addTo(map).bindPopup('Endereço encontrado').openPopup();
          } else {
            alert('Endereço não encontrado');
          }
        });
    }

    // Alternando entre modo claro e escuro
    document.getElementById('theme-toggle').addEventListener('click', () => {
      const html = document.documentElement;
      const isDark = html.getAttribute('data-bs-theme') === 'dark';
      html.setAttribute('data-bs-theme', isDark ? 'light' : 'dark');
      document.getElementById('theme-toggle').innerHTML = isDark
        ? '<i class="bi bi-sun-fill"></i> Modo Claro'
        : '<i class="bi bi-moon-fill"></i> Modo Escuro';
    });
  </script>
</body>
</html>
