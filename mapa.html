<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Pontos de Ônibus - BusWay</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" />
  <style>
    #map { height: 100vh; }
    #chat {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 300px;
      height: 400px;
      background-color: white;
      border: 1px solid #ccc;
      padding: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
    }
    #chat input {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
    }
    #chat button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
    }
    .message {
      margin: 10px 0;
    }
    .message strong {
      font-weight: bold;
    }
    .dropdown {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
    }
  </style>
</head>
<body>

  <div class="dropdown">
    <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
      Selecione o tipo de ponto
    </button>
    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
      <li><a class="dropdown-item" href="#" onclick="filterPoints('onibus')">Ônibus</a></li>
      <li><a class="dropdown-item" href="#" onclick="filterPoints('terminal')">Terminal</a></li>
      <li><a class="dropdown-item" href="#" onclick="filterPoints('estacao')">Estação</a></li>
    </ul>
  </div>

  <div id="map"></div>

  <div id="chat">
    <div id="messages"></div>
    <input type="text" id="userInput" placeholder="Digite sua pergunta...">
    <button onclick="enviarMensagem()">Enviar</button>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/openai/1.1.2/openai.min.js"></script>
  
  <script>
    // Configuração do Firebase
 const firebaseConfig = {
    apiKey: "AIzaSyA-UgQXLtsg1tj0MBpLndSuJiS2hqXRc6c",
    authDomain: "busway-4df70.firebaseapp.com",
    databaseURL: "https://busway-4df70-default-rtdb.firebaseio.com",
    projectId: "busway-4df70",
    storageBucket: "busway-4df70.appspot.com",
    messagingSenderId: "688309345550",
    appId: "1:688309345550:web:761e34139b05a1f8578b5f",
    measurementId: "G-94KF7CBDLZ"
  };
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database(app);

    // Inicializar o mapa
    const map = L.map('map').setView([-23.5505, -46.6333], 13); // Posição inicial (São Paulo)

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Função para obter a localização do usuário e centralizar o mapa
    function getUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          map.setView([lat, lon], 13);
          L.marker([lat, lon]).addTo(map)
            .bindPopup('Você está aqui!')
            .openPopup();
        }, function() {
          alert("Erro ao obter localização.");
        });
      } else {
        alert("Geolocalização não suportada pelo seu navegador.");
      }
    }

    // Função para carregar os pontos de ônibus no mapa
    function loadBusStops(type = '') {
      database.ref('pontos').once('value', function(snapshot) {
        const pontos = snapshot.val();
        for (let pontoId in pontos) {
          const ponto = pontos[pontoId];
          if (type === '' || ponto.tipo === type) {
            const lat = ponto.latitude;
            const lon = ponto.longitude;
            const nome = ponto.nome;
            const tipo = ponto.tipo;
            const descricao = ponto.descricao || 'Sem descrição';

            // Adicionar marcador no mapa
            L.marker([lat, lon]).addTo(map)
              .bindPopup(`<strong>${nome}</strong><br>${tipo}<br>${descricao}`);
          }
        }
      });
    }

    // Filtrar pontos com base no tipo
    function filterPoints(type) {
      map.eachLayer(function(layer) {
        if (layer instanceof L.Marker) {
          map.removeLayer(layer);
        }
      });
      loadBusStops(type);
    }

    // Função do chat IA
    async function enviarMensagem() {
      const input = document.getElementById('userInput');
      const chat = document.getElementById('messages');
      const texto = input.value.trim();
      if (!texto) return;

      // Mostrar pergunta do usuário
      const userMsg = document.createElement('div');
      userMsg.classList.add('message');
      userMsg.innerHTML = `<strong>Você:</strong> ${texto}`;
      chat.appendChild(userMsg);

      // Mensagem de "pensando..."
      const respostaMsg = document.createElement('div');
      respostaMsg.classList.add('message');
      respostaMsg.innerHTML = `<strong>IA:</strong> ... pensando ...`;
      chat.appendChild(respostaMsg);

      input.value = '';

      // Chamar a OpenAI para obter a resposta
      const apiKey = "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"; // substitua pela sua chave
      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [
            { role: "system", content: "Você é um assistente que ajuda as pessoas a encontrar pontos de ônibus." },
            { role: "user", content: texto }
          ]
        })
      });
      const data = await response.json();
      const resposta = data.choices[0].message.content;

      respostaMsg.innerHTML = `<strong>IA:</strong> ${resposta}`;
      chat.scrollTop = chat.scrollHeight;
    }

    // Carregar os pontos de ônibus ao carregar a página
    loadBusStops();
    getUserLocation();
  </script>
</body>
</html>
